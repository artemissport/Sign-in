<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>11æœˆç­ä»»å‹™å›å ±è¡¨å–®</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700;900&family=Outfit:wght@400;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary: #FF6B35;
      --primary-dark: #E55A2B;
      --primary-light: #FFF0EB;
      --accent: #004E89;
      --accent-light: #E8F1FA;
      --bg: #FAFAF7;
      --surface: #FFFFFF;
      --text: #1A1A1A;
      --text-secondary: #6B6B6B;
      --border: #E2E2DD;
      --success: #2ECC71;
      --error: #E74C3C;
      --shadow-sm: 0 1px 3px rgba(0,0,0,0.06);
      --shadow-md: 0 4px 16px rgba(0,0,0,0.08);
      --shadow-lg: 0 8px 32px rgba(0,0,0,0.1);
      --radius: 12px;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Noto Sans TC', sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      line-height: 1.6;
    }

    /* Header */
    .header {
      background: linear-gradient(135deg, var(--primary) 0%, #FF8C5A 50%, var(--primary-dark) 100%);
      padding: 48px 24px 56px;
      text-align: center;
      position: relative;
      overflow: hidden;
    }

    .header::before {
      content: '';
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: radial-gradient(circle at 30% 40%, rgba(255,255,255,0.12) 0%, transparent 60%);
      pointer-events: none;
    }

    .header::after {
      content: '';
      position: absolute;
      bottom: -2px;
      left: 0;
      right: 0;
      height: 24px;
      background: var(--bg);
      border-radius: 24px 24px 0 0;
    }

    .header h1 {
      font-family: 'Outfit', 'Noto Sans TC', sans-serif;
      font-size: clamp(1.6rem, 5vw, 2.4rem);
      font-weight: 800;
      color: #fff;
      letter-spacing: -0.5px;
      position: relative;
      text-shadow: 0 2px 8px rgba(0,0,0,0.15);
    }

    .header p {
      color: rgba(255,255,255,0.85);
      margin-top: 8px;
      font-size: 0.95rem;
      font-weight: 300;
    }

    /* Form Container */
    .form-container {
      max-width: 640px;
      margin: -20px auto 40px;
      padding: 0 16px;
      position: relative;
    }

    .form-card {
      background: var(--surface);
      border-radius: var(--radius);
      box-shadow: var(--shadow-md);
      padding: 32px 28px;
      margin-bottom: 16px;
      border: 1px solid var(--border);
      transition: box-shadow 0.2s;
    }

    .form-card:hover {
      box-shadow: var(--shadow-lg);
    }

    .form-card.required::before {
      content: '';
      position: absolute;
      left: 0;
      top: 12px;
      bottom: 12px;
      width: 4px;
      background: var(--primary);
      border-radius: 0 4px 4px 0;
    }

    .form-card {
      position: relative;
    }

    /* Labels */
    .field-label {
      font-size: 1.05rem;
      font-weight: 700;
      color: var(--text);
      margin-bottom: 6px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .field-label .required-star {
      color: var(--error);
      font-size: 1.1rem;
    }

    .field-desc {
      font-size: 0.82rem;
      color: var(--text-secondary);
      margin-bottom: 14px;
      line-height: 1.5;
      padding: 8px 12px;
      background: var(--primary-light);
      border-radius: 8px;
      border-left: 3px solid var(--primary);
    }

    /* Inputs */
    input[type="text"],
    input[type="date"],
    textarea {
      width: 100%;
      padding: 12px 16px;
      border: 2px solid var(--border);
      border-radius: 10px;
      font-size: 1rem;
      font-family: 'Noto Sans TC', sans-serif;
      color: var(--text);
      background: var(--bg);
      transition: all 0.2s;
      outline: none;
    }

    input:focus, textarea:focus {
      border-color: var(--primary);
      background: #fff;
      box-shadow: 0 0 0 4px rgba(255, 107, 53, 0.1);
    }

    input.error, textarea.error {
      border-color: var(--error);
      box-shadow: 0 0 0 4px rgba(231, 76, 60, 0.1);
    }

    .error-msg {
      color: var(--error);
      font-size: 0.8rem;
      margin-top: 6px;
      display: none;
    }

    .error-msg.show {
      display: block;
    }

    textarea {
      min-height: 100px;
      resize: vertical;
    }

    /* Checkbox Section */
    .checkbox-group {
      margin-top: 8px;
    }

    .checkbox-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 14px;
      margin-bottom: 6px;
      border-radius: 8px;
      cursor: pointer;
      transition: background 0.15s;
      user-select: none;
    }

    .checkbox-item:hover {
      background: var(--bg);
    }

    .checkbox-item input[type="checkbox"] {
      appearance: none;
      -webkit-appearance: none;
      width: 22px;
      height: 22px;
      border: 2px solid var(--border);
      border-radius: 6px;
      cursor: pointer;
      position: relative;
      flex-shrink: 0;
      transition: all 0.2s;
      background: #fff;
    }

    .checkbox-item input[type="checkbox"]:checked {
      background: var(--primary);
      border-color: var(--primary);
    }

    .checkbox-item input[type="checkbox"]:checked::after {
      content: 'âœ“';
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: #fff;
      font-size: 14px;
      font-weight: 700;
    }

    .checkbox-item label {
      font-size: 0.95rem;
      cursor: pointer;
      flex: 1;
    }

    /* Section Title */
    .section-title {
      font-size: 1.1rem;
      font-weight: 700;
      color: var(--accent);
      margin-bottom: 4px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .section-title .emoji {
      font-size: 1.2rem;
    }

    .week-badge {
      display: inline-block;
      background: var(--accent-light);
      color: var(--accent);
      font-size: 0.72rem;
      font-weight: 600;
      padding: 3px 10px;
      border-radius: 20px;
      margin-bottom: 10px;
    }

    /* Task Card Images */
    .task-images {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
      margin-top: 8px;
    }

    .task-image-wrapper {
      border-radius: 10px;
      overflow: hidden;
      border: 2px solid var(--border);
      background: var(--bg);
      aspect-ratio: 1/1;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .task-image-wrapper img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .task-image-placeholder {
      text-align: center;
      color: var(--text-secondary);
      padding: 20px;
    }

    .task-image-placeholder .icon {
      font-size: 2.5rem;
      margin-bottom: 8px;
    }

    /* Submit Button */
    .submit-btn {
      width: 100%;
      padding: 16px;
      background: linear-gradient(135deg, var(--primary), var(--primary-dark));
      color: #fff;
      border: none;
      border-radius: 12px;
      font-size: 1.1rem;
      font-weight: 700;
      font-family: 'Noto Sans TC', sans-serif;
      cursor: pointer;
      transition: all 0.25s;
      box-shadow: 0 4px 16px rgba(255,107,53,0.3);
      letter-spacing: 1px;
    }

    .submit-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 24px rgba(255,107,53,0.4);
    }

    .submit-btn:active {
      transform: translateY(0);
    }

    .submit-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }

    /* Toast */
    .toast {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%) translateY(-120px);
      background: var(--success);
      color: #fff;
      padding: 16px 32px;
      border-radius: 12px;
      font-weight: 600;
      box-shadow: var(--shadow-lg);
      transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
      z-index: 1000;
    }

    .toast.error {
      background: var(--error);
    }

    .toast.show {
      transform: translateX(-50%) translateY(0);
    }

    /* Loading Overlay */
    .loading-overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(255,255,255,0.8);
      backdrop-filter: blur(4px);
      z-index: 999;
      justify-content: center;
      align-items: center;
    }

    .loading-overlay.show {
      display: flex;
    }

    .spinner {
      width: 48px;
      height: 48px;
      border: 4px solid var(--border);
      border-top-color: var(--primary);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Footer */
    .footer {
      text-align: center;
      padding: 24px;
      color: var(--text-secondary);
      font-size: 0.8rem;
    }

    /* Responsive */
    @media (max-width: 480px) {
      .form-card { padding: 24px 20px; }
      .header { padding: 36px 16px 48px; }
      .task-images { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>

  <!-- Toast -->
  <div class="toast" id="toast"></div>

  <!-- Loading -->
  <div class="loading-overlay" id="loading">
    <div class="spinner"></div>
  </div>

  <!-- Header -->
  <div class="header">
    <h1>ğŸ“‹ 11æœˆç­ä»»å‹™å›å ±è¡¨å–®</h1>
    <p>è«‹ä¾åºå¡«å¯«ä»¥ä¸‹æ¬„ä½å®Œæˆä»Šæ—¥ä»»å‹™å›å ±</p>
  </div>

  <div class="form-container">
    <form id="reportForm" novalidate>

      <!-- 1. å­¸è™Ÿ -->
      <div class="form-card">
        <div class="field-label">
          1. å­¸è™Ÿ <span class="required-star">*</span>
        </div>
        <div class="field-desc">
          è«‹å¡«å¯«å­¸è™Ÿå‰ä¸ƒç¢¼ï¼Œä¾‹å¦‚ 2201001-3Aï¼Œè«‹å¡«å¯«ã€Œ2201001ã€
        </div>
        <input type="text" id="studentId" maxlength="7" minlength="7"
               placeholder="è«‹è¼¸å…¥7ç¢¼å­¸è™Ÿ" inputmode="numeric" pattern="\d{7}" required>
        <div class="error-msg" id="studentIdError">è«‹è¼¸å…¥æ­£ç¢ºçš„7ç¢¼å­¸è™Ÿï¼ˆåƒ…é™æ•¸å­—ï¼‰</div>
      </div>

      <!-- 2. ä»»å‹™æ—¥æœŸ -->
      <div class="form-card">
        <div class="field-label">
          2. ä»»å‹™æ—¥æœŸ <span class="required-star">*</span>
        </div>
        <div class="field-desc">
          å¹´ä»½å¡«å¯«è¥¿å…ƒ
        </div>
        <input type="date" id="taskDate" required>
      </div>

      <!-- 3. é£²é£Ÿä¸Šå‚³ -->
      <div class="form-card">
        <div class="field-label">
          3. ğŸ‘‰ ä»Šæ—¥å·²ç¶“ä¸Šå‚³é£²é£Ÿï¼ˆè‡³å°‘ä¸€é¤ï¼‰ <span class="required-star">*</span>
        </div>
        <div class="field-desc">
          æœªä¸Šå‚³çš„ã€Œä¸éœ€ã€é¸å–
        </div>
        <div class="checkbox-group">
          <div class="checkbox-item">
            <input type="checkbox" id="mealUploaded" value="å·²ä¸Šå‚³">
            <label for="mealUploaded">å·²ä¸Šå‚³</label>
          </div>
        </div>
      </div>

      <!-- 4. Add -->
      <div class="form-card" id="addSection">
        <div class="field-label">
          4. ğŸ‘‰ Add <span class="required-star">*</span>
        </div>
        <div class="field-desc">
          å®Œæˆçš„æ‰“å‹¾ï¼Œæœªå®Œæˆçš„ã€Œä¸éœ€ã€é¸å–
        </div>
        <div id="addCurrentWeek"></div>
        <div class="checkbox-group" id="addCheckboxes"></div>
      </div>

      <!-- 5. Behavior -->
      <div class="form-card" id="behaviorSection">
        <div class="field-label">
          5. ğŸ‘‰ Behavior <span class="required-star">*</span>
        </div>
        <div class="field-desc">
          å®Œæˆçš„æ‰“å‹¾ï¼Œæœªå®Œæˆçš„ã€Œä¸éœ€ã€é¸å–
        </div>
        <div id="behaviorCurrentWeek"></div>
        <div class="checkbox-group" id="behaviorCheckboxes"></div>
      </div>

      <!-- 6. Clear -->
      <div class="form-card" id="clearSection">
        <div class="field-label">
          6. ğŸ§¹ Clear <span class="required-star">*</span>
        </div>
        <div class="field-desc">
          å®Œæˆçš„æ‰“å‹¾ï¼Œæœªå®Œæˆçš„ã€Œä¸éœ€ã€é¸å–
        </div>
        <div id="clearCurrentWeek"></div>
        <div class="checkbox-group" id="clearCheckboxes"></div>
      </div>

      <!-- 7. ç•™è¨€ -->
      <div class="form-card">
        <div class="field-label">
          7. æƒ³è·Ÿæ ¡é•·åŠåœ˜éšŠèªªçš„è©±
        </div>
        <textarea id="message" placeholder="åœ¨é€™è£¡ç•™ä¸‹ä½ æƒ³èªªçš„è©±..."></textarea>
      </div>

      <!-- ä»»å‹™å¡åœ–ç‰‡ -->
      <div class="form-card">
        <div class="section-title">
          <span class="emoji">ğŸƒ</span> æœ¬é€±ä»»å‹™å¡
        </div>
        <div id="taskCardWeekBadge" class="week-badge"></div>
        <div class="task-images">
          <div class="task-image-wrapper" id="taskCard1">
            <div class="task-image-placeholder">
              <div class="icon">ğŸ–¼ï¸</div>
              <div>ä»»å‹™å¡ A</div>
            </div>
          </div>
          <div class="task-image-wrapper" id="taskCard2">
            <div class="task-image-placeholder">
              <div class="icon">ğŸ–¼ï¸</div>
              <div>ä»»å‹™å¡ B</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Submit -->
      <div class="form-card" style="border: none; box-shadow: none; background: transparent; padding: 0;">
        <button type="submit" class="submit-btn" id="submitBtn">
          é€å‡ºå›å ± âœ…
        </button>
      </div>

    </form>
  </div>

  <div class="footer">
    11æœˆç­ä»»å‹™å›å ±ç³»çµ± Â© 2025
  </div>

<script>
// ====================================================================
// ğŸ“Œ è¨­å®šå€ - è«‹æ ¹æ“šéœ€è¦ä¿®æ”¹ä»¥ä¸‹å…§å®¹
// ====================================================================

// ğŸ”— Google Apps Script Web App URLï¼ˆéƒ¨ç½²å¾Œè²¼ä¸Šä½ çš„URLï¼‰
const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyArFBvuBEpcBzEJDrd16rrXQrcWBm3PBrrzdu1T8OIpB9C6SR8aDSdsvVzeXpnizYF/exec';

// ğŸ“… èª²ç¨‹é–‹å§‹æ—¥æœŸï¼ˆç”¨ä¾†åˆ¤æ–·ç•¶å‰æ˜¯ç¬¬å¹¾é€±ï¼‰
const COURSE_START_DATE = new Date('2026-01-12'); // èª²ç¨‹é–‹å§‹æ—¥æœŸï¼š2026/1/12

// ğŸ“‹ 12é€±ä»»å‹™è³‡æ–™
// æ¯é€±çš„ add / behavior / clear ä»»å‹™å…§å®¹
// ä½ å¯ä»¥é å…ˆæŠŠ12é€±çš„ä»»å‹™éƒ½å¯«å¥½
const WEEKLY_TASKS = {
  1: {
    add: ['æ¯é¤æœ€å°‘åƒ1æ‰‹æŒè”¬èœ'],
    behavior: ['åŸ·è¡Œé€²é£Ÿé †åºèœ>è‚‰>é£¯'],
    clear: ['ä¸åƒç‚¸ç‰©'],
    cardImage1: 'images/card_a_week1.png',
    cardImage2: 'images/card_b_week1.png',
  },
  2: {
    add: ['æ¯å¤©èµ°5åƒæ­¥'],
    behavior: ['ç©ºè…¹12å°æ™‚'],
    clear: ['ä¸å–å«ç³–é£²æ–™'],
    cardImage1: 'images/card_a_week2.png',
    cardImage2: 'images/card_b_week2.png',
  },
  3: {
    add: ['æ¯å¤©å®Œæˆä¸€å ‚ç·šä¸Šèª²ç¨‹'],
    behavior: ['æ¯é¤é£¯å¾Œç«™ç«‹æˆ–èµ°è·¯10ï½15åˆ†é˜'],
    clear: ['ä¸åƒé¤…ä¹¾ã€é›¶é£Ÿ'],
    cardImage1: 'images/card_a_week3.png',
    cardImage2: 'images/card_b_week3.png',
  },
  4: {
    add: ['æ¯å¤©å–æ°´è‡³å°‘2000cc'],
    behavior: ['æ¯å£é£Ÿç‰©å’€åš¼30ä¸‹'],
    clear: ['ä¸åƒç”œé»'],
    cardImage1: 'images/card_a_week4.png',
    cardImage2: 'images/card_b_week4.png',
  },
  5: {
    add: ['æ¯é¤åƒä¸€ç¨®è›‹ç™½è³ªé£Ÿç‰©'],
    behavior: ['ç©ºè…¹14å°æ™‚'],
    clear: ['ä¸ç«™ä¸Šé«”é‡è¨ˆ'],
    cardImage1: 'images/card_a_week5.png',
    cardImage2: 'images/card_b_week5.png',
  },
  6: {
    add: ['æ¯å¤©èµ°7åƒæ­¥'],
    behavior: ['æ¯æ—¥ç¡æ»¿7-8å°æ™‚'],
    clear: ['ä¸åƒé†£(ç³–)æ²¹æ··å’Œç‰©'],
    cardImage1: 'images/card_a_week6.png',
    cardImage2: 'images/card_b_week6.png',
  },
  7: {
    add: ['æ¯é¤åƒåˆ°ä¸€ç¨®å¤©ç„¶ç¢³æ°´åŒ–åˆç‰©'],
    behavior: ['æ¯å¤©è¶…æ…¢è·‘10åˆ†é˜'],
    clear: ['åˆ°ä¾¿åˆ©å•†åº—ä¸è²·é›¶é£Ÿã€é£²æ–™'],
    cardImage1: 'images/card_a_week7.png',
    cardImage2: 'images/card_b_week7.png',
  },
  8: {
    add: ['æ¯å¤©åƒ10-20å…‹ç„¡èª¿å‘³å …æœ'],
    behavior: ['æ¯å¤©æ›¬å¤ªé™½15-20åˆ†é˜'],
    clear: ['ç¡å‰4å°æ™‚ä¸åƒæ±è¥¿'],
    cardImage1: 'images/card_a_week8.png',
    cardImage2: 'images/card_b_week8.png',
  },
  9: {
    add: ['æ¯å¤©æ·±è¹²60ä¸‹'],
    behavior: ['æ¯å¤©è¶…æ…¢è·‘20åˆ†é˜'],
    clear: ['ä¸å–é…’ç²¾é£²æ–™'],
    cardImage1: 'images/card_a_week9.png',
    cardImage2: 'images/card_b_week9.png',
  },
  10: {
    add: ['æ¯å¤©æ”å–ä¸€ç¨®å¥½æ²¹'],
    behavior: ['æ¯å¤©èµ·åºŠå°é¡å­èªªä½ æ˜¯æœ€æ£’çš„'],
    clear: ['ä¸åƒç”œé»'],
    cardImage1: 'images/card_a_week10.png',
    cardImage2: 'images/card_b_week10.png',
  },
  11: {
    add: ['æ¯å¤©ç¡å‰æ ¸å¿ƒè¨“ç·´ä¸‰åˆ†é˜'],
    behavior: ['æ¯å‘¨é¸3-4å¤©ç©ºè…¹16å°æ™‚'],
    clear: ['ç¡å‰4å°æ™‚ä¸åƒæ±è¥¿'],
    cardImage1: 'images/card_a_week11.png',
    cardImage2: 'images/card_b_week11.png',
  },
  12: {
    add: ['æ¯å¤©è·Ÿå®¶äºº/æœ‹å‹åˆ†äº«ä¸€å€‹å¥åº·è³‡è¨Šæˆ–æ¸›é‡çš„å•é¡Œ'],
    behavior: ['æ¯å¤©è®šç¾è‡ªå·±ä¸€å€‹å„ªé»æˆ–ä½ è¦ºå¾—åšçš„å¾ˆæ£’çš„ä¸€ä»¶äº‹'],
    clear: ['ä¸èµ·è² é¢å¿µé ­'],
    cardImage1: 'images/card_a_week12.png',
    cardImage2: 'images/card_b_week12.png',
  },
};

// ====================================================================
// ğŸ”§ é‚è¼¯å€ - ä¸€èˆ¬ä¸éœ€ä¿®æ”¹
// ====================================================================

// è¨ˆç®—ç›®å‰æ˜¯ç¬¬å¹¾é€±
function getCurrentWeek() {
  const now = new Date();
  const diffTime = now - COURSE_START_DATE;
  const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
  const week = Math.floor(diffDays / 7) + 1;
  return Math.max(1, Math.min(12, week));
}

// ç”¢ç”Ÿ checkbox HTMLï¼ˆç´¯ç©åˆ°ç•¶é€±ï¼‰
function generateCheckboxes(containerId, category, currentWeek) {
  const container = document.getElementById(containerId);
  container.innerHTML = '';

  // æ”¶é›†å¾ç¬¬ 1 é€±åˆ°ç•¶é€±çš„æ‰€æœ‰ä»»å‹™ï¼ˆå»é‡ï¼‰
  const allTasks = [];
  for (let w = 1; w <= currentWeek; w++) {
    if (WEEKLY_TASKS[w] && WEEKLY_TASKS[w][category]) {
      WEEKLY_TASKS[w][category].forEach(task => {
        if (!allTasks.includes(task)) {
          allTasks.push(task);
        }
      });
    }
  }

  allTasks.forEach((task, idx) => {
    const id = `${category}_${idx}`;
    const item = document.createElement('div');
    item.className = 'checkbox-item';
    item.innerHTML = `
      <input type="checkbox" id="${id}" value="${task}" name="${category}">
      <label for="${id}">${task}</label>
    `;
    container.appendChild(item);
  });
}

// é¡¯ç¤ºé€±æ•¸ badge
function showWeekBadge(elementId, week) {
  const el = document.getElementById(elementId);
  el.innerHTML = `<span class="week-badge">ç›®å‰ç‚ºç¬¬ ${week} é€±</span>`;
}

// è¼‰å…¥ä»»å‹™å¡åœ–ç‰‡
function loadTaskCards(week) {
  const badge = document.getElementById('taskCardWeekBadge');
  badge.textContent = `ç¬¬ ${week} é€±ä»»å‹™å¡`;

  const card1 = document.getElementById('taskCard1');
  const card2 = document.getElementById('taskCard2');

  const weekData = WEEKLY_TASKS[week];
  if (weekData) {
    if (weekData.cardImage1) {
      card1.innerHTML = `<img src="${weekData.cardImage1}" alt="ä»»å‹™å¡A - ç¬¬${week}é€±">`;
    }
    if (weekData.cardImage2) {
      card2.innerHTML = `<img src="${weekData.cardImage2}" alt="ä»»å‹™å¡B - ç¬¬${week}é€±">`;
    }
  }
}

// åˆå§‹åŒ–è¡¨å–®
function initForm() {
  const currentWeek = getCurrentWeek();

  // è¨­å®šæ—¥æœŸé è¨­ç‚ºä»Šå¤©
  const today = new Date();
  document.getElementById('taskDate').valueAsDate = today;

  // ç”¢ç”Ÿå„å€å¡Šçš„ checkbox
  generateCheckboxes('addCheckboxes', 'add', currentWeek);
  generateCheckboxes('behaviorCheckboxes', 'behavior', currentWeek);
  generateCheckboxes('clearCheckboxes', 'clear', currentWeek);

  // é¡¯ç¤ºé€±æ•¸
  showWeekBadge('addCurrentWeek', currentWeek);
  showWeekBadge('behaviorCurrentWeek', currentWeek);
  showWeekBadge('clearCurrentWeek', currentWeek);

  // è¼‰å…¥ä»»å‹™å¡
  loadTaskCards(currentWeek);
}

// å­¸è™Ÿé©—è­‰
const studentIdInput = document.getElementById('studentId');
studentIdInput.addEventListener('input', function () {
  this.value = this.value.replace(/\D/g, '').slice(0, 7);
  if (this.value.length === 7) {
    this.classList.remove('error');
    document.getElementById('studentIdError').classList.remove('show');
  }
});

studentIdInput.addEventListener('blur', function () {
  if (this.value.length !== 7) {
    this.classList.add('error');
    document.getElementById('studentIdError').classList.add('show');
  }
});

// å–å¾—å‹¾é¸çš„ checkbox å€¼
function getCheckedValues(name) {
  const checked = document.querySelectorAll(`input[name="${name}"]:checked`);
  return Array.from(checked).map(cb => cb.value).join(', ');
}

// Toast é€šçŸ¥
function showToast(msg, isError = false) {
  const toast = document.getElementById('toast');
  toast.textContent = msg;
  toast.className = isError ? 'toast error show' : 'toast show';
  setTimeout(() => toast.classList.remove('show'), 3500);
}

// æ ¼å¼åŒ–æ™‚é–“æˆ³è¨˜
function formatTimestamp() {
  const now = new Date();
  const y = now.getFullYear();
  const m = String(now.getMonth() + 1).padStart(2, '0');
  const d = String(now.getDate()).padStart(2, '0');
  const h = String(now.getHours()).padStart(2, '0');
  const min = String(now.getMinutes()).padStart(2, '0');
  const sec = String(now.getSeconds()).padStart(2, '0');
  return `${y}/${m}/${d} ${h}:${min}:${sec}`;
}

// æ ¼å¼åŒ–ä»»å‹™æ—¥æœŸ
function formatTaskDate(dateStr) {
  if (!dateStr) return '';
  const d = new Date(dateStr);
  const y = d.getFullYear();
  const m = String(d.getMonth() + 1).padStart(2, '0');
  const day = String(d.getDate()).padStart(2, '0');
  return `${y}/${m}/${day}`;
}

// é€å‡ºè¡¨å–®
document.getElementById('reportForm').addEventListener('submit', async function (e) {
  e.preventDefault();

  // é©—è­‰å­¸è™Ÿ
  const studentId = document.getElementById('studentId').value;
  if (studentId.length !== 7 || !/^\d{7}$/.test(studentId)) {
    document.getElementById('studentId').classList.add('error');
    document.getElementById('studentIdError').classList.add('show');
    document.getElementById('studentId').scrollIntoView({ behavior: 'smooth', block: 'center' });
    return;
  }

  // é©—è­‰æ—¥æœŸ
  const taskDate = document.getElementById('taskDate').value;
  if (!taskDate) {
    showToast('è«‹é¸æ“‡ä»»å‹™æ—¥æœŸ', true);
    return;
  }

  const btn = document.getElementById('submitBtn');
  const loading = document.getElementById('loading');
  btn.disabled = true;
  loading.classList.add('show');

  // æ”¶é›†è³‡æ–™
  const formData = {
    timestamp: formatTimestamp(),                              // Aæ¬„
    studentId: studentId,                                       // Bæ¬„
    message: document.getElementById('message').value || '',    // Eæ¬„
    taskDate: formatTaskDate(taskDate),                         // Gæ¬„
    mealUploaded: document.getElementById('mealUploaded').checked ? 'å·²ä¸Šå‚³' : '',  // Hæ¬„
    addTasks: getCheckedValues('add'),                          // Iæ¬„
    behaviorTasks: getCheckedValues('behavior'),                // Jæ¬„
    clearTasks: getCheckedValues('clear'),                      // Kæ¬„
  };

  try {
    // ä½¿ç”¨ URLSearchParams ä»¥ application/x-www-form-urlencoded æ ¼å¼é€å‡º
    // é€™æ˜¯èˆ‡ Google Apps Script æœ€ç›¸å®¹çš„æ–¹å¼
    const params = new URLSearchParams();
    params.append('data', JSON.stringify(formData));

    const response = await fetch(GOOGLE_SCRIPT_URL, {
      method: 'POST',
      body: params,
    });

    const result = await response.json();

    if (result.result === 'success') {
      showToast('âœ… å›å ±æˆåŠŸï¼æ„Ÿè¬ä½ çš„åŠªåŠ› ğŸ’ª');
      // é‡ç½®è¡¨å–®ï¼ˆä¿ç•™å­¸è™Ÿå’Œæ—¥æœŸï¼‰
      document.getElementById('mealUploaded').checked = false;
      document.querySelectorAll('input[name="add"], input[name="behavior"], input[name="clear"]').forEach(cb => cb.checked = false);
      document.getElementById('message').value = '';
    } else {
      showToast('âŒ é€å‡ºå¤±æ•—ï¼š' + (result.message || 'æœªçŸ¥éŒ¯èª¤'), true);
    }

  } catch (error) {
    console.error('Error:', error);
    showToast('âŒ é€å‡ºå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦', true);
  } finally {
    btn.disabled = false;
    loading.classList.remove('show');
  }
});

// å•Ÿå‹•
initForm();
</script>

</body>
</html>
